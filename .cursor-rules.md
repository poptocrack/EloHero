---
title: 'EloHero â€“ Cursor Rules'
description: >
  RÃ¨gles de dÃ©veloppement, architecture et contraintes produit pour EloHero,
  une application mobile de classement ELO communautaire basÃ©e sur Firebase et React Native.
cursor_rules:
  applies_to:
    - '*/**'
  priority: 100
  guidelines:
    - Ne jamais Ã©crire de logique ELO directement dans le client.
    - Toutes les Ã©critures Firestore passent par des Cloud Functions sÃ©curisÃ©es.
    - Appliquer strictement les limites Free/Premium selon les custom claims Firebase.
    - Utiliser Firestore uniquement pour la lecture cÃ´tÃ© app.
    - Respecter la structure et les hiÃ©rarchies de donnÃ©es dÃ©crites ci-dessous.
    - Ne pas gÃ©nÃ©rer de code serveur sans validation explicite.
---

# ğŸ§© EloHero â€“ Cursor Rules

## ğŸ¯ Objectif gÃ©nÃ©ral

EloHero est une application mobile permettant Ã  un **groupe de joueurs** dâ€™organiser un **classement ELO dynamique** basÃ© sur leurs parties.  
Chaque partie saisie met Ã  jour les scores ELO des participants selon leur placement et leur score prÃ©cÃ©dent.

Lâ€™application doit Ãªtre :

- Simple Ã  utiliser
- Fiable dans les calculs
- Facile Ã  maintenir
- BasÃ©e sur Firebase + React Native (Expo)

---

## ğŸ§  FonctionnalitÃ©s principales

### Classement & parties

- CrÃ©er des groupes de joueurs
- Enregistrer une partie (joueurs, ordre de classement, ex Ã¦quo)
- Calcul automatique du nouvel ELO pour chaque joueur
- Historique des parties et variations ELO
- Classement visible et mis Ã  jour en temps rÃ©el

### Gestion des groupes

- Rejoindre un groupe via un **code dâ€™invitation**
- CrÃ©er des **groupes saisonniers** (Premium)
- Visualiser les **classements par saison**

---

## ğŸ’ Abonnement et limitations

| Plan        | Groupes maximum | Taille max groupe | Saisons | Autres                          |
| ----------- | --------------- | ----------------- | ------- | ------------------------------- |
| **Free**    | 2               | 5 membres         | Non     | Fonctions de base               |
| **Premium** | IllimitÃ©        | IllimitÃ©          | Oui     | Groupes saisonniers + reset ELO |

- Gestion de lâ€™abonnement via **Stripe Extension** (Firebase)
- `plan` stockÃ© dans les **custom claims**
- Les rÃ¨gles de limitation sont appliquÃ©es **uniquement cÃ´tÃ© backend**

---

## ğŸ” Authentification

- **Firebase Auth** (email + Google/Apple)
- Chaque utilisateur a un document `/users/{uid}` avec :
  - `displayName`, `photoURL`
  - `plan` (`free` | `premium`)
  - `groupsCount`
  - `stripeCustomerId` (optionnel)

---

## ğŸ—ƒï¸ Structure Firestore

users/{uid}
groups/{groupId}
members/{uid}
seasons/{seasonId}
ratings/{seasonId_uid}
games/{gameId}
participants/{uid}
ratingChanges/{gameId_uid}
invites/{code}
subscriptions/{uid}

### Principes de structure

- Subcollections pour Ã©viter les arrays volumineux
- Transactions pour tout calcul ou mise Ã  jour ELO
- AgrÃ©gations locales (`memberCount`, `groupsCount`, `gameCount`) pour Ã©viter les requÃªtes coÃ»teuses
- Une seule **saison active** par groupe Ã  la fois

---

## âš™ï¸ Algorithme ELO

- SystÃ¨me **multi-joueurs avec placements et ex Ã¦quo**
- Chaque match est converti en duels virtuels
- Score attendu `Eij` via formule ELO classique
- Score rÃ©el `Sij` basÃ© sur le placement
- Ajustement progressif selon le nombre de parties :
  - `K_eff = K_base * (1 / (1 + gamesPlayed / n0))`
  - Valeurs par dÃ©faut : `K_base = 32`, `n0 = 30`, `rating_init = 1200`

Toutes les mises Ã  jour dâ€™ELO se font via la Cloud Function `reportMatch`.

---

## ğŸ”§ Cloud Functions attendues

1. **createGroup**  
   CrÃ©e un groupe selon le plan utilisateur et ajoute le crÃ©ateur comme owner.

2. **joinGroupWithCode**  
   VÃ©rifie les limites et ajoute lâ€™utilisateur au groupe.

3. **createSeason**  
   Premium only â€” crÃ©e une nouvelle saison active et dÃ©sactive lâ€™ancienne.

4. **reportMatch**  
   Valide les joueurs, calcule les ELO, Ã©crit les mises Ã  jour (atomiques).

5. **stripeWebhook**  
   Met Ã  jour les abonnements et les claims Firebase.

6. **scheduledCleanups**  
   Nettoyage des invitations expirÃ©es, reset automatique des saisons.

---

## ğŸ”’ SÃ©curitÃ© & RÃ¨gles

- Aucune Ã©criture directe cÃ´tÃ© client.
- Toutes les mutations (crÃ©ation groupe, match, saison) passent par des callables.
- Lecture autorisÃ©e uniquement aux membres dâ€™un groupe.
- Les documents sensibles (`users`, `subscriptions`) sont lisibles uniquement par leur propriÃ©taire.
- Les limites Free/Premium sont appliquÃ©es **dans les fonctions**, jamais cÃ´tÃ© client.

---

## ğŸ“± Application mobile (Expo)

### Stack technique

- React Native + Expo SDK
- TypeScript
- React Query (Firestore data)
- Zustand (Ã©tat local)
- React Navigation
- Sentry (erreurs)
- Expo EAS (build & OTA updates)

### Ã‰crans clÃ©s

1. Auth (connexion / inscription)
2. Mes groupes (liste + compteur)
3. Groupe (classement, parties, saisie, saisons)
4. Historique (rÃ©sultats, variations)
5. Abonnement (Stripe)
6. Profil joueur (statistiques â€“ V2)

---

## ğŸ§­ UX â€“ parcours essentiels

### Saisie dâ€™une partie

- SÃ©lection multiple des joueurs
- Drag & drop pour ordonner les placements
- Option dâ€™ex Ã¦quo
- Validation â†’ envoi Ã  `reportMatch`
- Retour visuel immÃ©diat des variations dâ€™ELO

### Classement

- Tableau triÃ© par score
- Filtre saison / classement global
- Mise Ã  jour temps rÃ©el via Firestore

### Historique

- Liste chronologique des parties
- DÃ©tails du match et delta ELO

---

## ğŸ“ˆ Bonnes pratiques

- Calculs uniquement cÃ´tÃ© serveur (jamais dans le client)
- Stockage minimal cÃ´tÃ© app
- Transactions Firestore pour toute Ã©criture critique
- Limiter les rÃ¨gles Firestore Ã  la lecture
- Toujours vÃ©rifier `plan` (free/premium) cÃ´tÃ© backend
- AgrÃ©gats mis Ã  jour dans les callables (jamais cÃ´tÃ© client)

---

## ğŸš€ Ã‰volutions futures (V2+)

- Types de jeux (1v1, Ã©quipes)
- Graphique de progression
- SuccÃ¨s / badges
- Export CSV / intÃ©gration Discord
- Notifications push
- Auto-reset des saisons
- Mode offline avancÃ©

---

## ğŸ§¾ SynthÃ¨se technique

| Domaine         | Choix                            |
| --------------- | -------------------------------- |
| Mobile          | React Native + Expo (TypeScript) |
| Backend         | Firebase Functions               |
| Base de donnÃ©es | Firestore                        |
| Auth            | Firebase Auth                    |
| Paiement        | Stripe (Extension Firebase)      |
| Monitoring      | Sentry                           |
| Analytics       | PostHog / Amplitude              |
| Build           | Expo EAS                         |
| Planification   | Scheduled Cloud Functions        |

---

## âœ… Directives Cursor

- Ne jamais injecter de logique de calcul ELO cÃ´tÃ© client.
- Les Ã©critures Firestore ne se font **jamais** depuis le client.
- Les Custom Claims Firebase (`plan`) dÃ©terminent les droits premium.
- Les modifications structurelles de la base doivent respecter la hiÃ©rarchie donnÃ©e.
- Toute gÃ©nÃ©ration de code backend nÃ©cessite validation explicite de lâ€™auteur.
- Prioriser la simplicitÃ© et la cohÃ©rence du modÃ¨le Firebase-first.
