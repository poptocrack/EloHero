---
title: 'EloHero – Cursor Rules'
description: >
  Règles de développement, architecture et contraintes produit pour EloHero,
  une application mobile de classement ELO communautaire basée sur Firebase et React Native.
cursor_rules:
  applies_to:
    - '*/**'
  priority: 100
  guidelines:
    - Ne jamais écrire de logique ELO directement dans le client.
    - Toutes les écritures Firestore passent par des Cloud Functions sécurisées.
    - Appliquer strictement les limites Free/Premium selon les custom claims Firebase.
    - Utiliser Firestore uniquement pour la lecture côté app.
    - Respecter la structure et les hiérarchies de données décrites ci-dessous.
    - Ne pas générer de code serveur sans validation explicite.
---

# 🧩 EloHero – Cursor Rules

## 🎯 Objectif général

EloHero est une application mobile permettant à un **groupe de joueurs** d’organiser un **classement ELO dynamique** basé sur leurs parties.  
Chaque partie saisie met à jour les scores ELO des participants selon leur placement et leur score précédent.

L’application doit être :

- Simple à utiliser
- Fiable dans les calculs
- Facile à maintenir
- Basée sur Firebase + React Native (Expo)

---

## 🧠 Fonctionnalités principales

### Classement & parties

- Créer des groupes de joueurs
- Enregistrer une partie (joueurs, ordre de classement, ex æquo)
- Calcul automatique du nouvel ELO pour chaque joueur
- Historique des parties et variations ELO
- Classement visible et mis à jour en temps réel

### Gestion des groupes

- Rejoindre un groupe via un **code d’invitation**
- Créer des **groupes saisonniers** (Premium)
- Visualiser les **classements par saison**

---

## 💎 Abonnement et limitations

| Plan        | Groupes maximum | Taille max groupe | Saisons | Autres                          |
| ----------- | --------------- | ----------------- | ------- | ------------------------------- |
| **Free**    | 2               | 5 membres         | Non     | Fonctions de base               |
| **Premium** | Illimité        | Illimité          | Oui     | Groupes saisonniers + reset ELO |

- Gestion de l’abonnement via **Stripe Extension** (Firebase)
- `plan` stocké dans les **custom claims**
- Les règles de limitation sont appliquées **uniquement côté backend**

---

## 🔐 Authentification

- **Firebase Auth** (email + Google/Apple)
- Chaque utilisateur a un document `/users/{uid}` avec :
  - `displayName`, `photoURL`
  - `plan` (`free` | `premium`)
  - `groupsCount`
  - `stripeCustomerId` (optionnel)

---

## 🗃️ Structure Firestore

users/{uid}
groups/{groupId}
members/{uid}
seasons/{seasonId}
ratings/{seasonId_uid}
games/{gameId}
participants/{uid}
ratingChanges/{gameId_uid}
invites/{code}
subscriptions/{uid}

### Principes de structure

- Subcollections pour éviter les arrays volumineux
- Transactions pour tout calcul ou mise à jour ELO
- Agrégations locales (`memberCount`, `groupsCount`, `gameCount`) pour éviter les requêtes coûteuses
- Une seule **saison active** par groupe à la fois

---

## ⚙️ Algorithme ELO

- Système **multi-joueurs avec placements et ex æquo**
- Chaque match est converti en duels virtuels
- Score attendu `Eij` via formule ELO classique
- Score réel `Sij` basé sur le placement
- Ajustement progressif selon le nombre de parties :
  - `K_eff = K_base * (1 / (1 + gamesPlayed / n0))`
  - Valeurs par défaut : `K_base = 32`, `n0 = 30`, `rating_init = 1200`

Toutes les mises à jour d’ELO se font via la Cloud Function `reportMatch`.

---

## 🔧 Cloud Functions attendues

1. **createGroup**  
   Crée un groupe selon le plan utilisateur et ajoute le créateur comme owner.

2. **joinGroupWithCode**  
   Vérifie les limites et ajoute l’utilisateur au groupe.

3. **createSeason**  
   Premium only — crée une nouvelle saison active et désactive l’ancienne.

4. **reportMatch**  
   Valide les joueurs, calcule les ELO, écrit les mises à jour (atomiques).

5. **stripeWebhook**  
   Met à jour les abonnements et les claims Firebase.

6. **scheduledCleanups**  
   Nettoyage des invitations expirées, reset automatique des saisons.

---

## 🔒 Sécurité & Règles

- Aucune écriture directe côté client.
- Toutes les mutations (création groupe, match, saison) passent par des callables.
- Lecture autorisée uniquement aux membres d’un groupe.
- Les documents sensibles (`users`, `subscriptions`) sont lisibles uniquement par leur propriétaire.
- Les limites Free/Premium sont appliquées **dans les fonctions**, jamais côté client.

---

## 📱 Application mobile (Expo)

### Stack technique

- React Native + Expo SDK
- TypeScript
- React Query (Firestore data)
- Zustand (état local)
- React Navigation
- Sentry (erreurs)
- Expo EAS (build & OTA updates)

### Écrans clés

1. Auth (connexion / inscription)
2. Mes groupes (liste + compteur)
3. Groupe (classement, parties, saisie, saisons)
4. Historique (résultats, variations)
5. Abonnement (Stripe)
6. Profil joueur (statistiques – V2)

---

## 🧭 UX – parcours essentiels

### Saisie d’une partie

- Sélection multiple des joueurs
- Drag & drop pour ordonner les placements
- Option d’ex æquo
- Validation → envoi à `reportMatch`
- Retour visuel immédiat des variations d’ELO

### Classement

- Tableau trié par score
- Filtre saison / classement global
- Mise à jour temps réel via Firestore

### Historique

- Liste chronologique des parties
- Détails du match et delta ELO

---

## 📈 Bonnes pratiques

- Calculs uniquement côté serveur (jamais dans le client)
- Stockage minimal côté app
- Transactions Firestore pour toute écriture critique
- Limiter les règles Firestore à la lecture
- Toujours vérifier `plan` (free/premium) côté backend
- Agrégats mis à jour dans les callables (jamais côté client)

---

## 🚀 Évolutions futures (V2+)

- Types de jeux (1v1, équipes)
- Graphique de progression
- Succès / badges
- Export CSV / intégration Discord
- Notifications push
- Auto-reset des saisons
- Mode offline avancé

---

## 🧾 Synthèse technique

| Domaine         | Choix                            |
| --------------- | -------------------------------- |
| Mobile          | React Native + Expo (TypeScript) |
| Backend         | Firebase Functions               |
| Base de données | Firestore                        |
| Auth            | Firebase Auth                    |
| Paiement        | Stripe (Extension Firebase)      |
| Monitoring      | Sentry                           |
| Analytics       | PostHog / Amplitude              |
| Build           | Expo EAS                         |
| Planification   | Scheduled Cloud Functions        |

---

## ✅ Directives Cursor

- Ne jamais injecter de logique de calcul ELO côté client.
- Les écritures Firestore ne se font **jamais** depuis le client.
- Les Custom Claims Firebase (`plan`) déterminent les droits premium.
- Les modifications structurelles de la base doivent respecter la hiérarchie donnée.
- Toute génération de code backend nécessite validation explicite de l’auteur.
- Prioriser la simplicité et la cohérence du modèle Firebase-first.
